# Система управления банковскими картами (Bank Cards API)

REST-сервис для управления банковскими картами и переводами средств между ними в рамках тестового задания.

## Требования

- JDK 21
- Maven 3.9+
- Docker и Docker Compose

## Стек

- Java 21
- Maven 3.9
- Spring Boot 3 (MVC, Security, Data JPA)
- PostgreSQL 15
- JUnit 5 и Mockito
- OpenAPI и Swagger UI
- Liquibase
- Docker и Docker Compose

## Быстрый старт

### 1. Сборка JAR-файла

```bash
mvn clean package
```
### 2. Сборка образа и запуск контейнеров

```bash
docker compose up --build
```

После старта приложение будет доступно по адресу: `http://localhost:8080`

## Документация

Документация доступна после старта приложения:

- Swagger UI: `http://localhost:8080/swagger-ui/index.html`
  (кнопка **Authorize** позволяет задать JWT-токен, который будет автоматически подставляться во все запросы)
- OpenAPI-спецификация:
    - `http://localhost:8080/v3/api-docs` — JSON
    - `http://localhost:8080/v3/api-docs.yaml` — YAML
    - YAML-спецификация также лежит в директории `docs/` и доступна без запуска приложения.

## Авторизация

Авторизация основана на JWT-токенах.

HTTP-запрос:

```http
POST /auth/login
Content-Type: application/json
```

Тело запроса (пример):

```json
{
  "username": "user",
  "password": "user123"
}
```

Пример успешного ответа:
```json
{
  "token": "eyJhbGciOiJIUzI1NiJ9eyJzdWIi..."
}
```

Для запросов к защищённым эндпоинтам использовать заголовок:

```http
Authorization: Bearer <jwt_token>
```

### Тестовые пользователи

При первом запуске создаются тестовые пользователи:

| Логин | Пароль    | Роль   |
|-------|-----------|--------|
| user  | user123   | USER   |
| admin | admin123  | ADMIN  |

## API
### Методы аутентификации

| Метод | URL           | Описание                                       |
| ----- | ------------- |------------------------------------------------|
| POST  | `/auth/login` | Аутентификация пользователя, выдача JWT-токена |

### Методы для управления картами любых пользователей (роль ADMIN)

| Метод  | URL                               | Описание                                        |
| ------ | --------------------------------- | ----------------------------------------------- |
| POST   | `/admin/cards`                    | Создать новую карту для указанного пользователя |
| PATCH  | `/admin/cards/{id}`               | Обновить данные карты по ID                     |
| GET    | `/admin/cards/{id}`               | Получить карту по ID (любого пользователя)      |
| GET    | `/admin/cards`                    | Список всех карт (постранично)                  |
| POST   | `/admin/cards/{id}/activate`      | Активировать карту                              |
| POST   | `/admin/cards/{id}/block-approve` | Подтвердить блокировку карты                    |
| DELETE | `/admin/cards/{id}`               | Удалить карту по ID                             |

### Методы для работы со своими картами и переводами (роли USER и ADMIN)

| Метод | URL                         | Описание                                                            |
| ----- | --------------------------- |---------------------------------------------------------------------|
| GET   | `/cards`                    | Список карт текущего пользователя (постранично, фильтр по `status`) |
| GET   | `/cards/{id}`               | Получить карту текущего пользователя по ID                          |
| POST  | `/cards/{id}/block-request` | Отправить запрос на блокировку своей карты                          |
| GET   | `/cards/{id}/balance`       | Получить текущий баланс по своей карте                              |
| POST  | `/transfers`                | Создать перевод между картами (от имени текущего пользователя)      |

### Обработка ошибок

Сервис использует следующие коды ошибок:

- `400 Bad Request` — ошибка валидации входных данных
- `401 Unauthorized` — отсутствует или неверный JWT, неверный логин/пароль
- `403 Forbidden` — недостаточно прав (роль не подходит)
- `404 Not Found` — сущность не найдена (карта, пользователь, перевод)
- `409 Conflict` — конфликт бизнес-логики (например, просроченная карта или недопустимый статус для операции)
- `500 Internal Server Error` — непредвиденная ошибка на сервере

## Миграции БД

Схема базы данных управляется Liquibase.
При старте приложения автоматически применяются скрипты из `src/main/resources/db/migration/`.

## Тесты

В проекте есть unit-тесты для основной бизнес-логики (операции с картами и переводами),
написанные с использованием JUnit 5 и Mockito.

Запуск всех тестов:
```bash
mvn test
```